<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMRL Induction Planner - Interactive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .train-card {
            transition: all 0.2s;
        }
        .train-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .train-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .path-line {
            stroke: #3b82f6;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <h1 class="text-4xl font-bold mb-2 text-gray-800">KMRL Induction Planner</h1>
        <p class="text-gray-600 mb-6">Select trains to find optimal assignment path</p>

        <!-- Selection Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Select Trains</h2>
                <div class="flex gap-2">
                    <button onclick="selectAll()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Select All
                    </button>
                    <button onclick="deselectAll()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Deselect All
                    </button>
                    <button onclick="solveOptimal()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center gap-2">
                        <span id="solve-btn-text">Find Optimal Path</span>
                        <span id="solve-loading" class="loading hidden"></span>
                    </button>
                </div>
            </div>
            
            <div id="trains-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Train cards will be populated here -->
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-600">Total Trains</p>
                    <p id="summary-total" class="text-2xl font-bold">—</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-600">Assigned</p>
                    <p id="summary-assigned" class="text-2xl font-bold text-green-600">—</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-600">Unassigned</p>
                    <p id="summary-unassigned" class="text-2xl font-bold text-red-600">—</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-600">Total Cost</p>
                    <p id="summary-cost" class="text-2xl font-bold">—</p>
                </div>
            </div>

            <!-- Optimal Path Visualization -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">Optimal Assignment Path</h2>
                <div id="path-visualization" class="min-h-[300px] border-2 border-gray-200 rounded p-4">
                    <!-- SVG visualization will be rendered here -->
                </div>
            </div>

            <!-- Detailed Assignments Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b">
                    <h2 class="text-2xl font-semibold">Detailed Assignments</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Train ID</th>
                                <th class="px-4 py-3 text-left">Assigned Slot</th>
                                <th class="px-4 py-3 text-left">Role</th>
                                <th class="px-4 py-3 text-left">Readiness</th>
                                <th class="px-4 py-3 text-left">Mileage</th>
                                <th class="px-4 py-3 text-left">Shunt</th>
                                <th class="px-4 py-3 text-left">Total Cost</th>
                                <th class="px-4 py-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="assignments-table">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let allTrains = [];
        let selectedTrainIds = new Set();

        // Load trains on page load
        async function loadTrains() {
            try {
                const response = await fetch(`${API_BASE}/trains`);
                const data = await response.json();
                allTrains = data.trains;
                renderTrains();
            } catch (error) {
                console.error('Error loading trains:', error);
                document.getElementById('trains-container').innerHTML = 
                    '<p class="text-red-500">Error loading trains. Make sure the backend is running.</p>';
            }
        }

        function renderTrains() {
            const container = document.getElementById('trains-container');
            container.innerHTML = allTrains.map(train => `
                <div class="train-card border-2 rounded-lg p-4 cursor-pointer ${selectedTrainIds.has(train.train_id) ? 'selected border-blue-500 bg-blue-50' : 'border-gray-200'}"
                     onclick="toggleTrain('${train.train_id}')">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg">${train.train_id}</h3>
                        <input type="checkbox" ${selectedTrainIds.has(train.train_id) ? 'checked' : ''} 
                               onchange="toggleTrain('${train.train_id}')" class="w-5 h-5">
                    </div>
                    <div class="text-sm space-y-1">
                        <p><span class="font-semibold">Mileage:</span> ${train.mileage_km.toLocaleString()} km</p>
                        <p><span class="font-semibold">Readiness:</span> 
                            <span class="${train.readiness_score >= 4 ? 'text-red-600' : train.readiness_score >= 1 ? 'text-yellow-600' : 'text-green-600'}">
                                ${train.readiness_score}
                            </span>
                        </p>
                        <div class="flex gap-2 mt-2">
                            ${train.blocked ? '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">Blocked</span>' : ''}
                            ${!train.certificates_valid ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Cert Invalid</span>' : ''}
                            ${!train.cleaning_done ? '<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">Cleaning Pending</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleTrain(trainId) {
            if (selectedTrainIds.has(trainId)) {
                selectedTrainIds.delete(trainId);
            } else {
                selectedTrainIds.add(trainId);
            }
            renderTrains();
        }

        function selectAll() {
            allTrains.forEach(train => selectedTrainIds.add(train.train_id));
            renderTrains();
        }

        function deselectAll() {
            selectedTrainIds.clear();
            renderTrains();
        }

        async function solveOptimal() {
            if (selectedTrainIds.size === 0) {
                alert('Please select at least one train');
                return;
            }

            const btn = document.getElementById('solve-btn-text');
            const loading = document.getElementById('solve-loading');
            btn.textContent = 'Solving...';
            loading.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/solve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ train_ids: Array.from(selectedTrainIds) })
                });

                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                displayResults(data);
            } catch (error) {
                console.error('Error solving:', error);
                alert('Error solving. Make sure the backend is running.');
            } finally {
                btn.textContent = 'Find Optimal Path';
                loading.classList.add('hidden');
            }
        }

        function displayResults(data) {
            // Show results section
            document.getElementById('results-section').classList.remove('hidden');

            // Update summary
            document.getElementById('summary-total').textContent = data.summary.total_trains;
            document.getElementById('summary-assigned').textContent = data.summary.assigned;
            document.getElementById('summary-unassigned').textContent = data.summary.unassigned;
            document.getElementById('summary-cost').textContent = `₹${data.summary.total_cost.toFixed(2)}`;

            // Render path visualization
            renderPathVisualization(data.assignments);

            // Render assignments table
            renderAssignmentsTable(data.assignments);
        }

        function renderPathVisualization(assignments) {
            const container = document.getElementById('path-visualization');
            const assigned = assignments.filter(a => a.is_assigned);
            
            if (assigned.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No assignments found. All trains are unassigned.</p>';
                return;
            }

            // Create SVG visualization
            const width = container.clientWidth - 32;
            const height = Math.max(300, assigned.length * 80);
            
            const svg = `
                <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#3b82f6" />
                        </marker>
                    </defs>
                    ${assigned.map((assignment, idx) => {
                        const y = 40 + idx * 80;
                        const trainX = 50;
                        const slotX = width - 150;
                        
                        return `
                            <g>
                                <rect x="${trainX - 40}" y="${y - 20}" width="80" height="40" rx="5" 
                                      fill="#3b82f6" fill-opacity="0.1" stroke="#3b82f6" stroke-width="2"/>
                                <text x="${trainX}" y="${y + 5}" text-anchor="middle" font-weight="bold">${assignment.train_id}</text>
                                
                                <path d="M ${trainX + 40} ${y} L ${slotX - 40} ${y}" 
                                      class="path-line" stroke-dasharray="${assignment.total_cost > 50 ? '5,5' : 'none'}"/>
                                
                                <rect x="${slotX - 40}" y="${y - 20}" width="80" height="40" rx="5" 
                                      fill="#10b981" fill-opacity="0.1" stroke="#10b981" stroke-width="2"/>
                                <text x="${slotX}" y="${y - 5}" text-anchor="middle" font-size="12">${assignment.slot_info.slot_id}</text>
                                <text x="${slotX}" y="${y + 10}" text-anchor="middle" font-size="10" fill="#666">${assignment.role}</text>
                                
                                <text x="${(trainX + slotX) / 2}" y="${y - 10}" text-anchor="middle" 
                                      font-size="11" fill="#666">Cost: ₹${assignment.total_cost.toFixed(2)}</text>
                            </g>
                        `;
                    }).join('')}
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        function renderAssignmentsTable(assignments) {
            const tbody = document.getElementById('assignments-table');
            tbody.innerHTML = assignments.map(assignment => `
                <tr class="border-t ${assignment.is_assigned ? 'bg-green-50' : 'bg-red-50'}">
                    <td class="px-4 py-3 font-semibold">${assignment.train_id}</td>
                    <td class="px-4 py-3">${assignment.assigned_slot || '—'}</td>
                    <td class="px-4 py-3">
                        ${assignment.role ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm">${assignment.role}</span>` : '—'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="${assignment.readiness_score >= 4 ? 'text-red-600' : assignment.readiness_score >= 1 ? 'text-yellow-600' : 'text-green-600'}">
                            ${assignment.readiness_score}
                        </span>
                    </td>
                    <td class="px-4 py-3">${assignment.mileage_score.toFixed(2)}</td>
                    <td class="px-4 py-3">${assignment.shunt_score.toFixed(2)}</td>
                    <td class="px-4 py-3 font-semibold">${assignment.total_cost ? '₹' + assignment.total_cost.toFixed(2) : '—'}</td>
                    <td class="px-4 py-3">
                        ${assignment.is_assigned 
                            ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-sm">Assigned</span>'
                            : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-sm">Unassigned</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // Initialize on page load
        loadTrains();
    </script>
</body>
</html>





